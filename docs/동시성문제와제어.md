## 동시성 문제와 제어방법
- - -

### 1. 동시성 문제 이해하기
- - -
- 동시성 문제는 동일한 하나의 데이터에 둘 이상의 스레드, 혹은 세션에서 가변 데이터를 동시에 제어할 때 나타나는 문제.
- 하나의 세션이 데이터를 수정 중일때, 다른 세션에서 수정 전의 데이터를 조회해 로직을 처리함으로써 데이터의 정합성이 깨지는 문제.

#### 1-1. Race Condition
- 임계영역 (critical section : 공유 메모리에 접근하는 프로그램의 일부)이 두 개 이상의 스레드에 의해 동시에 실행되는 조건. 특정 공유 리소스를 얻기 위해 두 개 이상의 스레드가 함께 경쟁하는 조건으로 정의할 수 있으며 프로그램의 잘못된 동작으로 이어짐.
- Read - modify - write (읽기 수정 쓰기)
  - 동시에 2개 이상의 스레드가 값을 읽은 후 수정하고 덮어쓸 경우 발생하는 오류
- Check - then - act (확인 후 조치)
  - 스레드 A map의 key 확인 -> 스레드 B map의 key 확인 -> 스레드 A map의 value 제거 -> 스레드 B map의 value 제거 수행 시 오류

#### 1-2. DeadLock
- 둘 이상의 프로세스 혹은 스레드(트랜잭션)가 자원을 점유(Lock을 획득)한 상태에서 서로 다른 프로세스 혹은 스레드(트랜잭션)가 점유하고 있는 자원(Lock)을 요구하며 무한정 기다리는 상황

#### 1-3. Dirty Read
- 다른 트랜잭션에 의해 수정되었지만, 아직 커밋되지 않은 상태의 데이터를 읽는 것
![Image](https://github.com/user-attachments/assets/bc72b083-d13c-4103-bbd6-abb594ee9918)
- 트랜잭션 1에서 data2를 insert하고, 커밋하지 않은 상태에서 트랜잭션 2가 아직 커밋되지 않은 data2를 읽음. 해당 data2는 커밋될지, 롤백될지 알 수 없음

#### 1-4. Non-repeatable Read
- 하나의 트랜잭션에서 같은 키를 가진 데이터를 두 번 읽을 때, 그 결과가 다르게 나타나는 현상
![Image](https://github.com/user-attachments/assets/af837d51-2df6-4326-8856-b2ffe44a42c1)
- 첫 번째 Read와 두 번째 Read 사이에 다른 트랜잭션에서 값을 변경하거나 삭제하는 경우 결과가 다르게 나타나 트랜잭션의 일관성을 해치게 됨

#### 1-5. Phantom Read
- 일정 범위의 데이터를 여러 번 읽을 때, 첫 번째 쿼리에 없던 유령(Phantom)데이터가 두 번째 쿼리에서 나타나는 현상
![Image](https://github.com/user-attachments/assets/a148ac43-c08c-4e38-a676-d5d5210ad434)
- transaction1의 select1과 2 사이에 transaction2가 실행됨으로써 select1에서는 2개의 데이터, select2에서는 3개의 데이터가 조회

#### 1-6. E-커머스 시나리오에서의 동시성 문제
- 쿠폰 발행 시
- 재고 차감 시
- 유저 포인트의 사용, 충전 시

### 2. DB의 동시성 문제와 제어 방법
- - -
#### 2-1. DB Transaction Isolation Levels
- READ UNCOMMITTED
- READ COMMITTED
- REPEATABLE READ
- SERIALIZABLE

#### 2-2. DB Lock (S-lock, X-lock)
#### 2-3. Optimistic Lock
#### 2-4. Pessimistic Lock


### 3. DB Lock을 활용한 동시성 제어
- - -
#### 3-1. DB Lock
#### 3-2. S-lock (Shared Lock)
#### 3-3. X-lock (Exclusive Lock)
#### 3-4. Transaction Management


### 4. 분산 락과 비동기 처리
- - -
#### 4-1. Redis (Distributed Lock)
#### 4-2. Optimistic Lock
#### 4-3. Pessimistic Lock
#### 4-4. Retry Logic


### 5. Kafka와 메시지 큐를 통한 동시성 제어
- - -
#### 5-1. Kafka
#### 5-2. Message Queue
#### 5-3. Partitioning
#### 5-4. Event-driven Architecture