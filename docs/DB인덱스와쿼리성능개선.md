## 인덱스 (Index)
- - -
### 인덱스란?
- 인덱스란 추가적인 쓰기 작업과 저장 공간을 활용하여 데이터베이스 테이블의 검색 속도를 향상시키기 위한 자료구조
- 데이터베이스에서 테이블의 모든 데이터를 검색하면 기산이 오래 걸리기 때문에 데이터와 데이터의 위치를 포함한 자료구조를 생성하여 빠르게 조회할 수 있도록 도움
- 인덱스를 활용하면 데이터를 조회하는 SELECT 외에도 조회를 수반하는 UPDATE, DELETE의 성능도 함께 향상됨
  ![Image](https://github.com/user-attachments/assets/64e28bab-4c24-4c13-9c1e-51c57d5a80db)
- - -
### 인덱스의 관리
- DBMS는 인덱스를 항상 최신의 정렬된 상태로 유지해야 원하는 값을 빠르게 탐색 가능하기 때문에 인덱스가 적용된 칼럼에 INSERT, UPDATE, DELETE가 수행된다면 각각 다음의 연산을 추가로 해주어야함
- INSERT : 새로운 데이터에 대한 인덱스 추가
- DELETE : 삭제하는 데이터의 인덱스를 사용하지 않음 처리
- UPDATE : 기존의 인덱스를 사용하지 않음 처리하고 갱신된 데이터에 대해 인덱스 추가
- - -
### 인덱스의 장점과 단점
- 장점
  - 테이블을 조회하는 속도와 그에 따른 성능을 향상시킬 수 있다
  - 전반적인 데이터베이스의 부하를 줄일 수 있다
- 단점
  - 인덱스를 관리하기 위해 데이터베이스의 약 10%에 해당하는 저장공간이 추가로 필요하다
  - 인덱스를 관리하기 위해 추가 작업이 필요하다
  - CREATE, DELETE, UPDATE가 빈번한 속성에 인덱스를 걸게 되면 인덱스의 크기가 비대해져서 성능이 오히려 저하될 수 있다
    - UPDATE와 DELETE는 기존의 인덱스를 삭제하지 않고 사용하지 않음 처리만 하므로 실제 데이터보다 인덱스가 훨씬 더 많이 존재하게 되어 성능 저하를 유발한다
- - -
### 인덱스를 사용하면 좋은 경우
- 규모가 작지 않은 테이블
- INSERT, UPDATE, DELETE가 자주 발생하지 않는 칼럼
- JOIN이나 WHERE 또는 ORDER BY에 자주 사용되는 칼럼
- 데이터 중복도가 낮은 칼럼
- - -
### 카디널리티 (Cardinality)
- 카디널리티란 데이터베이스에서 테이블의 특정 칼럼에 저장된 값의 고유한 개수를 의미
- 일반적으로 칼럼 내 서로 다른 값들의 개수를 나타내며 데이터의 중복성 및 인덱스 성능과 밀접한 관계
- 높은 카디널리티
  - 칼럼 내 값들이 대부분 유일한 경우
  - 값이 다양할수록 인덱스를 활용한 검색 성능이 우수
  - B-Tree 인덱스가 효과적
  - EXPLAIN 실행 계획에서 Index Range Scan 방식으로 조회 가능
- 낮은 카디널리티
  - 칼럼 내 값들이 중복되는 경우가 많아 풀 스캔 (Full Scan) 이 발생할 가능성이 높음
  - 비트맵 인덱스 사용 가능 (Oracle 등 일부 DBMS에서 지원)
- - -
### 단일 칼럼 인덱스와 복합 칼럼 인덱스
1. 단일 칼럼 인덱스
    1. 정의
       1. 하나의 칼럼을 기준으로 생성된 인덱스
       2. 특정 칼럼을 검색할 때 빠른 조회
   2. 장점
      1. 단순하고 직관적
      2. 칼럼 값이 고유할수록 효과적
      3. 정렬 및 검색 속도 향상
   3. 단점
      1. 여러개의 조건이 있는 경우 비효율적
      2. 다중 칼럼 검색 시 인덱스가 하나만 사용될 수 있음
2. 복합 칼럼 인덱스
    1. 정의
       1. 두 개 이상의 칼럼을 조합하여 만든 인덱스
       2. 특정 칼럼 조합에 대해 검색 속도를 최적화
   2. 장점
      1. 자주 함께 검색되는 칼럼들의 조회 속도 향상
      2. 다중 칼럼을 활용한 효율적인 인덱스 탐색
      3. 첫 번째 칼럼 단독 검색도 인덱스 사용 가능
   3. 단점
      1. 칼럼 순서가 중요 (잘못 설정하면 성능 향상 효과가 낮음)
      2. 추가적인 저장 공간 필요
      3. 너무 많은 칼럼을 포함하면 인덱스 크기가 커져서 비효율적
3. 복합 칼럼 인덱스에서 칼럼 순서
- 복함 칼럼 인덱스는 왼쪽에서 오른쪽 방향으로 사용
- 카디널리티가 높은 칼럼을 앞에 배치하는 것이 일반적
```sql
CREATE INDEX idx_users_age_gender ON users(age, gender);
```
- WHERE age = 30 AND gender = 'M' : 인덱스 활용 가능
- WHERE gender = 'M' and age = 30 : 인덱스 활용 불가능 (age가 먼저 나와야 함)
- - -
### 인덱스를 사용할 때 주의할 점
- 인덱스 칼럼의 값과 타입을 그대로 사용해야 함
- LIKE, BETWEEN, <, > 등의 범위 조건을 사용하면 해당 칼럼까지만 인덱스를 사용하고 이후의 칼럼은 인덱스를 사용하지 않음
- AND 조건은 ROW를 줄이지만 OR은 비교를 위해 ROW를 늘리므로 Full Scan 발생 확률이 높다
- =, IN은 다음 칼럼에도 인덱스를 사용
- - -
### 인덱스 자료구조
1. 해시 테이블 (Hash Table)
- key-value로 데이터를 저장하는 자료구조 중 하나로 빠른 데이터 검색이 필요할 때 유용
- 등호 연산에만 특화되었기 때문에 부등호를 사용하는 검색에는 적합하지 않음

    ![Image](https://github.com/user-attachments/assets/40d78303-0b23-4a16-93a1-e671a016f18c)
2. B-Tree
- 이진 트리를 확장하여 N개의 자식을 가질 수 있도록 고안된 트리
- 가장 일반적으로 데이터베이스에서 사용되는 자료구조
- 하나의 노드에 여러 값이 저장되어 있는 경우 오름차순으로 정렬
  ![Image](https://github.com/user-attachments/assets/cfefb3c5-e142-4f8b-9068-3b9f4472da30)
3. B+Tree
- B-Tree에서 검색 성능을 개선한 자료구조
- InnoDB 엔진에서 인덱스를 관리할 때 사용
- B-Tree보다 검색 연산이 빠르고 범위 검색에 유용
![Image](https://github.com/user-attachments/assets/2a73bfb7-333b-4bd3-9509-d76f9294eae6)
- - -
### 실행계획 (EXPLAIN)
#### 1. 실행 계획이란?
- 데이터베이스는 쿼리를 실행할 때 3단계로 처리
1. SQL 파싱 : SQL 문법을 확인하고, 오류가 없는지 검증
2. SQL 옵티마이저 : 가장 효율적인 실행 경로를 선택
3. 실행 : 최적화된 실행 계획을 기반으로 데이터를 가져옴
- 실행 계획은 2번 단계에서 생성되며, 어떤 방식으로 데이터를 검색할 지 결정
- MySQL 에서는 쿼리 앞에 EXPLAIN을 붙여서 확인 가능
- - -
#### 2. 실행 계획에서 확인할수 있는 주요 항목
| 칼럼명 | 설명 |
|---|---|
|id|	쿼리의 실행 순서|
|select_type|	쿼리 유형 (단순 SIMPLE, 서브쿼리 SUBQUERY 등)|
|table|	조회되는 테이블 이름|
|type|	조인 방식 및 검색 방식 (FULL SCAN, INDEX SCAN 등)|
|possible_keys|	사용 가능한 인덱스 목록|
|key|	실제로 사용된 인덱스|
|key_len|	사용된 인덱스의 길이|
|ref|	어떤 컬럼을 기준으로 조인했는지|
|rows|	예상되는 검색 대상 행(row) 개수|
|filtered|	필터링된 레코드의 비율|
|extra|	추가적인 정보 (Using index, Using filesort 등)|
- - -
#### 3. 실행 계획에서 중요하게 봐야 할 부분
1) type 칼럼
- sql 실행 계획에서 type 값은 쿼리의 효율성을 평가

|type값|설명|성능|
|---|---|---|
|system|	1개의 행만 조회 (최고 성능)|좋음|
|const|	PK 또는 UNIQUE INDEX를 활용한 조회|좋음|
|eq_ref|	조인 시 PK/FK를 활용한 정확한 매칭|좋음|
|ref|	일반 인덱스를 활용한 검색 (비교적 빠름)|좋음|
|range|	BETWEEN, <, >, IN 등을 사용한 범위 검색|좋음|
|index|	인덱스 전체를 스캔 (Full Index Scan)|중간|
|ALL|	테이블 전체를 스캔 (Full Table Scan)|나쁨|

2) key 칼럼
- 실제 사용된 인덱스를 나타냄
- NULL이면 인덱스를 사용하지 않음
```sql
 EXPLAIN SELECT * FROM users WHERE email = 'test@example.com';
```
|id|select_type|table|type|possible_keys| key       |key_len|rows|extra|
|---|---|---|---|---|-----------|---|---|---|
|1|SIMPLE|users|ref|idx_email| idx_email |255|1|Using index|

3) extra 칼럼
- 추가적인 쿼리 정보

|  extra 값|	설명| 	성능 |
|---|---|-----|
|  Using index	|커버링 인덱스 사용 (쿼리 성능 향상)| 	좋음 |
 | Using where|	WHERE 조건 사용 (일반적)| 좋음  |
 | Using temporary|	임시 테이블 사용 (비효율적)| 	나쁨 |
  |Using filesort|	정렬이 필요한 경우 (ORDER BY 시 발생)| 	중간 |
- - -
## 서비스 주요 쿼리 - 쿼리 성능 개선을 위한 인덱스 적용
- - -